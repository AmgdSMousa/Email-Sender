<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø³Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .file-input {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-input:hover {
            border-color: #4CAF50;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
            margin-top: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-stop {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .status-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .pending { color: #ff9800; }

        .log-container {
            height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            color: white;
        }

        .log-success {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .log-error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .log-info {
            background: rgba(33, 150, 243, 0.3);
            color: #2196F3;
        }

        .email-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .email-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“§ Ù…Ø±Ø³Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
            <p>Ø£Ø±Ø³Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§ØªÙƒ Ù…Ø¹ Ù…Ø±ÙÙ‚Ø§Øª PDF ÙˆØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</p>
        </div>

        <div class="main-content">
            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div class="form-section">
                <div class="alert alert-warning">
                    âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SMTP Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡. Ø§Ø³ØªØ®Ø¯Ù… App Password Ù„Ù„Ù€ Gmail.
                </div>

                <h3 style="margin-bottom: 20px; color: #333;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SMTP</h3>
                
                <div class="form-group">
                    <label for="smtpServer">Ø®Ø§Ø¯Ù… SMTP:</label>
                    <select id="smtpServer">
                        <option value="smtp.gmail.com:587">Gmail (smtp.gmail.com:587)</option>
                        <option value="smtp.yahoo.com:587">Yahoo (smtp.yahoo.com:587)</option>
                        <option value="smtp.outlook.com:587">Outlook (smtp.outlook.com:587)</option>
                        <option value="custom">Ø®Ø§Ø¯Ù… Ù…Ø®ØµØµ</option>
                    </select>
                </div>

                <div class="form-group" id="customServer" style="display: none;">
                    <label for="customSmtp">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø®ØµØµ:</label>
                    <input type="text" id="customSmtp" placeholder="smtp.example.com:587">
                </div>

                <div class="form-group">
                    <label for="senderName">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</label>
                    <input type="text" id="senderName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªÙ„Ù…" value="Ø§Ù„Ù…Ø±Ø³Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
                </div>

                <div class="form-group">
                    <label for="senderEmail">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø³Ù„:</label>
                    <input type="email" id="senderEmail" placeholder="your-email@gmail.com" value="test@example.com">
                </div>

                <div class="form-group">
                    <label for="senderPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="senderPassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" value="********">
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #333;">ğŸ“ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>

                <div class="form-group">
                    <label for="emailSubject">Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                    <input type="text" id="emailSubject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" value="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©">
                </div>

                <div class="form-group">
                    <label for="emailBody">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (HTML Ù…Ø¯Ø¹ÙˆÙ…):</label>
                    <textarea id="emailBody" rows="6" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ

Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª.

Ù…Ø¹ ØªØ­ÙŠØ§ØªÙŠØŒ
ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</textarea>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #333;">ğŸ“ Ù…Ø±ÙÙ‚ PDF (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>

                <div class="form-group">
                    <div class="file-input" onclick="document.getElementById('pdfFile').click()">
                        <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
                        <p>ğŸ“„ Ø§Ø®ØªØ± Ù…Ù„Ù PDF Ù„Ù„Ø¥Ø±ÙØ§Ù‚</p>
                        <p style="font-size: 14px; color: #666; margin-top: 10px;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</p>
                    </div>
                </div>

                <div id="pdfPreview" class="email-list" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:</div>
                    <div id="pdfInfo"></div>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #333;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</h3>

                <div class="form-group">
                    <div class="file-input" onclick="document.getElementById('emailFile').click()">
                        <input type="file" id="emailFile" accept=".txt" style="display: none;">
                        <p>ğŸ“„ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†ØµÙˆØµ (.txt)</p>
                        <p style="font-size: 14px; color: #666; margin-top: 10px;">ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„ ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="manualEmails">Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹:</label>
                    <textarea id="manualEmails" rows="4" placeholder="test1@example.com&#10;test2@example.com&#10;test3@example.com">test1@example.com
test2@example.com
test3@example.com</textarea>
                </div>

                <div id="emailListPreview" class="email-list" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:</div>
                    <div id="emailListContent"></div>
                </div>

                <button class="btn" id="startSending" onclick="startSending()">
                    ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                </button>

                <button class="btn btn-stop" id="stopSending" onclick="stopSending()" style="display: none;">
                    â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                </button>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© -->
            <div class="status-section">
                <h3 style="margin-bottom: 20px; color: #333;">ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h3>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number success" id="successCount">0</div>
                        <div>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number error" id="errorCount">0</div>
                        <div>ÙØ´Ù„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number pending" id="totalCount">0</div>
                        <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; color: #333;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">
                        [Ø§Ù„Ù†Ø¸Ø§Ù…] Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙˆØ£Ø¯Ø®Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let emailList = [];
        let pdfAttachment = null;
        let isRunning = false;
        let shouldStop = false;
        let currentIndex = 0;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SMTP
        document.getElementById('smtpServer').addEventListener('change', function() {
            const customServer = document.getElementById('customServer');
            if (this.value === 'custom') {
                customServer.style.display = 'block';
            } else {
                customServer.style.display = 'none';
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
        document.getElementById('emailFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'text/plain') {
                const formData = new FormData();
                formData.append('emailFile', file);

                try {
                    addLogEntry('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª...');
                    const response = await fetch('/upload-emails', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        emailList = result.emails;
                        updateEmailDisplay();
                        updateStats();
                        addLogEntry('success', result.message);
                    } else {
                        addLogEntry('error', result.message);
                    }
                } catch (error) {
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø®Ø§Ø¯Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    addLogEntry('info', 'Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ØŒ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ù„ÙŠ...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        processEmailList(content);
                    };
                    reader.readAsText(file);
                }
            } else {
                addLogEntry('error', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù†ØµÙŠ ØµØ­ÙŠØ­ (.txt)');
            }
        });

        // Ù…ØªØ§Ø¨Ø¹Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        document.getElementById('manualEmails').addEventListener('input', function() {
            const content = this.value;
            if (content.trim()) {
                processEmailList(content);
            } else {
                emailList = [];
                updateEmailDisplay();
                updateStats();
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF
        document.getElementById('pdfFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                if (file.size > 10 * 1024 * 1024) {
                    addLogEntry('error', 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                    this.value = '';
                    return;
                }

                const formData = new FormData();
                formData.append('pdfFile', file);

                try {
                    addLogEntry('info', 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ù„Ù PDF...');
                    const response = await fetch('/upload-pdf', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        pdfAttachment = result;
                        displayPdfPreview();
                        addLogEntry('success', result.message);
                    } else {
                        addLogEntry('error', result.message);
                        this.value = '';
                    }
                } catch (error) {
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø®Ø§Ø¯Ù…
                    addLogEntry('error', 'Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDF Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù…');
                    this.value = '';
                }
            } else {
                addLogEntry('error', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF ØµØ­ÙŠØ­');
                this.value = '';
            }
        });

        function processEmailList(content) {
            const emails = content.split('\n')
                .map(email => email.trim())
                .filter(email => email && isValidEmail(email));

            emailList = [...new Set(emails)]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª
            updateEmailDisplay();
            updateStats();

            if (emailList.length > 0) {
                addLogEntry('success', `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${emailList.length} Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
            } else {
                addLogEntry('error', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ù†Øµ');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function updateEmailDisplay() {
            const preview = document.getElementById('emailListPreview');
            const content = document.getElementById('emailListContent');
            
            if (emailList.length > 0) {
                preview.style.display = 'block';
                content.innerHTML = emailList.slice(0, 10).map((email, index) => 
                    `<div style="padding: 2px 0;">${index + 1}. ${email}</div>`
                ).join('');
                
                if (emailList.length > 10) {
                    content.innerHTML += `<div style="padding: 2px 0; color: #666;">... Ùˆ ${emailList.length - 10} Ø¥ÙŠÙ…ÙŠÙ„ Ø¢Ø®Ø±</div>`;
                }
            } else {
                preview.style.display = 'none';
            }
        }

        function displayPdfPreview() {
            const preview = document.getElementById('pdfPreview');
            const info = document.getElementById('pdfInfo');
            
            if (pdfAttachment) {
                preview.style.display = 'block';
                const sizeInMB = (pdfAttachment.size / (1024 * 1024)).toFixed(2);
                info.innerHTML = `
                    <div style="padding: 8px; background: #e8f5e8; border-radius: 5px;">
                        <div>ğŸ“„ <strong>${pdfAttachment.name}</strong></div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Ø§Ù„Ø­Ø¬Ù…: ${sizeInMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                        </div>
                    </div>
                `;
            } else {
                preview.style.display = 'none';
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = emailList.length;
        }

        function addLogEntry(type, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function validateForm() {
            const senderEmail = document.getElementById('senderEmail').value;
            const senderPassword = document.getElementById('senderPassword').value;
            const emailSubject = document.getElementById('emailSubject').value;
            const emailBody = document.getElementById('emailBody').value;

            if (!senderEmail || !senderPassword || !emailSubject || !emailBody) {
                addLogEntry('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return false;
            }

            if (!isValidEmail(senderEmail)) {
                addLogEntry('error', 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø³Ù„ ØºÙŠØ± ØµØ­ÙŠØ­');
                return false;
            }

            if (emailList.length === 0) {
                addLogEntry('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return false;
            }

            return true;
        }

        async function startSending() {
            if (!validateForm() || isRunning) return;

            const smtpConfig = getSmtpConfig();
            const emailContent = getEmailContent();

            try {
                addLogEntry('info', 'Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                
                const response = await fetch('/send-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        smtpConfig: smtpConfig,
                        emailContent: emailContent,
                        emailList: emailList,
                        pdfAttachment: pdfAttachment
                    })
                });

                const result = await response.json();

                if (result.success) {
                    isRunning = true;
                    
                    const startButton = document.getElementById('startSending');
                    const stopButton = document.getElementById('stopSending');
                    
                    startButton.style.display = 'none';
                    stopButton.style.display = 'block';

                    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø©
                    statusInterval = setInterval(checkSendingStatus, 1000);
                    
                    addLogEntry('success', result.message);
                } else {
                    addLogEntry('error', result.message);
                }

            } catch (error) {
                addLogEntry('error', 'Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ...');
                // ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠ ÙƒÙ€ fallback
                await startLocalSending();
            }
        }

        async function startLocalSending() {
            isRunning = true;
            shouldStop = false;
            currentIndex = 0;
            
            const startButton = document.getElementById('startSending');
            const stopButton = document.getElementById('stopSending');
            
            startButton.style.display = 'none';
            stopButton.style.display = 'block';

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('successCount').textContent = '0';
            document.getElementById('errorCount').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';

            addLogEntry('info', `Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ ${emailList.length} Ø¥ÙŠÙ…ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ...`);
            addLogEntry('warning', 'ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ø§ ÙŠØ±Ø³Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©');

            // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø§ÙƒÙŠØ©
            await sendEmailsSequentially();
        }

        function getSmtpConfig() {
            const smtpServer = document.getElementById('smtpServer').value;
            const customSmtp = document.getElementById('customSmtp').value;
            const senderEmail = document.getElementById('senderEmail').value;
            const senderPassword = document.getElementById('senderPassword').value;
            
            let host, port;
            if (smtpServer === 'custom') {
                const parts = customSmtp.split(':');
                host = parts[0];
                port = parseInt(parts[1]) || 587;
            } else {
                const parts = smtpServer.split(':');
                host = parts[0];
                port = parseInt(parts[1]);
            }

            return {
                host: host,
                port: port,
                email: senderEmail,
                password: senderPassword
            };
        }

        function getEmailContent() {
            return {
                senderName: document.getElementById('senderName').value || 'Ø§Ù„Ù…Ø±Ø³Ù„',
                subject: document.getElementById('emailSubject').value,
                body: document.getElementById('emailBody').value
            };
        }

        async function checkSendingStatus() {
            try {
                const response = await fetch('/sending-status');
                const status = await response.json();

                updateStatsFromServer(status);

                if (!status.isRunning && isRunning) {
                    // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    isRunning = false;
                    clearInterval(statusInterval);
                    
                    const startButton = document.getElementById('startSending');
                    const stopButton = document.getElementById('stopSending');
                    
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                }

            } catch (error) {
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ø®Ø§Ø¯Ù…
                console.log('Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹');
            }
        }

        function updateStatsFromServer(status) {
            document.getElementById('successCount').textContent = status.sent;
            document.getElementById('errorCount').textContent = status.failed;
            document.getElementById('totalCount').textContent = status.total;
            
            const progress = status.total > 0 ? ((status.sent + status.failed) / status.total) * 100 : 0;
            document.getElementById('progressFill').style.width = progress + '%';

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            status.logs.forEach((log, index) => {
                const existingEntry = document.querySelector(`[data-log-index="${index}"]`);
                if (!existingEntry) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry log-${log.type}`;
                    entry.setAttribute('data-log-index', index);
                    entry.textContent = `[${log.timestamp}] ${log.message}`;
                    document.getElementById('logContainer').appendChild(entry);
                }
            });

            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„
            const logContainer = document.getElementById('logContainer');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function sendEmailsSequentially() {
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < emailList.length && !shouldStop; i++) {
                const email = emailList[i];
                currentIndex = i;

                addLogEntry('info', `Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰: ${email}`);

                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const success = await simulateEmailSending(email);
                
                if (success) {
                    successCount++;
                    addLogEntry('success', `âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${email}`);
                } else {
                    errorCount++;
                    addLogEntry('error', `âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰: ${email}`);
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø¯Ù…
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('errorCount').textContent = errorCount;
                
                const progress = ((i + 1) / emailList.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';

                // ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                if (i < emailList.length - 1 && !shouldStop) {
                    await simulateDelay(1500);
                }
            }

            // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            finishSending(successCount, errorCount);
        }

        async function simulateEmailSending(email) {
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ù†Ø¬Ø§Ø­ 85%
            await simulateDelay(1000 + Math.random() * 2000);
            return Math.random() > 0.15; // 85% Ù†Ø¬Ø§Ø­
        }

        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function finishSending(successCount, errorCount) {
            isRunning = false;
            shouldStop = false;
            
            const startButton = document.getElementById('startSending');
            const stopButton = document.getElementById('stopSending');
            
            startButton.style.display = 'block';
            stopButton.style.display = 'none';
            startButton.disabled = false;

            if (shouldStop) {
                addLogEntry('info', `ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ù†Ø¬Ø­: ${successCount}, ÙØ´Ù„: ${errorCount}`);
            } else {
                addLogEntry('info', `ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! Ù†Ø¬Ø­: ${successCount}, ÙØ´Ù„: ${errorCount}`);
            }
        }

        async function stopSending() {
            try {
                const response = await fetch('/stop-sending', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('info', result.message);
                }

            } catch (error) {
                // fallback Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ
                shouldStop = true;
                addLogEntry('info', 'Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        updateStats();
        processEmailList(document.getElementById('manualEmails').value);
        
        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
        addLogEntry('info', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª');
        addLogEntry('info', 'ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 3000 Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ');
    </script>
</body>
</html>
